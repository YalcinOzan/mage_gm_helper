<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Mage 20th Anniversary Edition - Reality Alteration Protocols. Unofficial fan tool for Rotes, Spheres, Rules and Dice Rolling.">
    <title>MAGE 20TH: Secret Library</title>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@500;600;700;800;900&family=Courier+Prime:wght@400;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="style.css?v=2.4">
</head>

<body>

    <div class="hero-header">
        <div class="brand-container">
            <h1 class="brand-title">MAGE 20TH: SECRET LIBRARY</h1>
            <div class="brand-subtitle">
                <span style="color:var(--warning)">UNOFFICIAL FAN TOOL</span> | Reality Alteration Protocols v2.5
            </div>
        </div>

        <div class="search-container">
            <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text"
                   id="searchBox"
                   class="search-bar"
                   placeholder="Search Rotes, Rules, Spheres..."
                   onkeyup="filterContent()">
        </div>

        <div></div>
    </div>

    <div class="nav-tabs">
        <button class="nav-btn" onclick="switchTab('tab-spheres', this)">🔮 Spheres</button>
        <button class="nav-btn" onclick="switchTab('tab-rotes', this)">📚 Rotes</button>
        <button class="nav-btn" onclick="switchTab('tab-rules', this)">⚖️ Rules</button>
        <button class="nav-btn" onclick="switchTab('tab-merits', this)">✨ Merits</button>
        <button class="nav-btn active" onclick="switchTab('tab-tools', this)">🎲 Tools</button>
    </div>

    <div class="content-area">

        <div id="tab-spheres" class="tab-page">
            <div class="grid-3" id="sphere-container"></div>
        </div>

        <div id="tab-rotes" class="tab-page">
            <div class="accordion">
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">⚔️ Combat & Martial Arts</div>
                    <div class="acc-content" id="cat-combat"></div>
                </div>
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">🧪 Transmutation & Elements</div>
                    <div class="acc-content" id="cat-transmutation"></div>
                </div>
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">🚀 Travel & Time</div>
                    <div class="acc-content" id="cat-travel"></div>
                </div>
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">🧠 Mind & Influence</div>
                    <div class="acc-content" id="cat-mind"></div>
                </div>
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">👻 Spirit, Necro & Wards</div>
                    <div class="acc-content" id="cat-spirit"></div>
                </div>
            </div>
        </div>

        <div id="tab-rules" class="tab-page">
            <div class="accordion" id="rules-container"></div>
        </div>

        <div id="tab-merits" class="tab-page">
            <div class="accordion">
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">💪 Physical Merits</div>
                    <div class="acc-content" id="cat-merit-phys"></div>
                </div>
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">🧠 Mental Merits</div>
                    <div class="acc-content" id="cat-merit-ment"></div>
                </div>
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">🤝 Social Merits</div>
                    <div class="acc-content" id="cat-merit-soc"></div>
                </div>
                <div class="acc-item">
                    <div class="acc-header" onclick="toggleAcc(this)">✨ Supernatural Merits</div>
                    <div class="acc-content" id="cat-merit-super"></div>
                </div>
                <div class="acc-item" style="border-color:var(--danger);">
                    <div class="acc-header" onclick="toggleAcc(this)" style="color:var(--danger);">⚠️ Flaws (Physical/Mental)</div>
                    <div class="acc-content" id="cat-flaw-phys"></div>
                </div>
                <div class="acc-item" style="border-color:var(--danger);">
                    <div class="acc-header" onclick="toggleAcc(this)" style="color:var(--danger);">🔮 Flaws (Supernatural)</div>
                    <div class="acc-content" id="cat-flaw-super"></div>
                </div>
            </div>
        </div>

        <div id="tab-tools" class="tab-page active">

            <div class="sub-nav">
                <button class="sub-nav-btn active" onclick="switchSubTab('sub-ritual', this)">🎴 Ritualmatic</button>
                <button class="sub-nav-btn" onclick="switchSubTab('sub-gens', this)">⚡ GM Generators</button>
            </div>

            <div id="sub-ritual" class="sub-tab-content active">
                <div class="rit-dashboard-v3">

                    <div class="rit-toolbar">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <h1 class="rit-title" style="font-size:1rem; margin:0;"
                                data-title="Ritualmatic Engine"
                                data-desc="Automated casting calculator for standard & extended rolls."
                                data-ref="M20 Core">
                                RITUALMATIC
                            </h1>
                            <button class="btn-reset" onclick="resetAll()"
                                    data-title="Reset All"
                                    data-desc="Clears all parameters to default state."
                                    data-ref="System"
                                    style="padding:4px 8px; font-size:0.6rem;">
                                RESET
                            </button>
                        </div>

                        <div class="mode-switch" style="width:140px;">
                            <div class="mode-opt active" id="btn-m-inst" onclick="setMode('instant')"
                                 data-title="Instant Casting"
                                 data-desc="Single turn action. Immediate results."
                                 data-ref="M20 p.538" style="padding:6px;">Inst</div>
                            <div class="mode-opt" id="btn-m-rit" onclick="setMode('ritual')"
                                 data-title="Ritual / Extended"
                                 data-desc="Accumulate successes over time (Extended Roll)."
                                 data-ref="M20 p.538" style="padding:6px;">Ritual</div>
                        </div>
                    </div>

                    <div class="stat-row">
                        <div class="input-group">
                            <label class="rit-label" data-title="Arete" data-desc="Dice Pool." data-ref="M20 Quickstart p.7">Arete</label>
                            <select id="arete" class="rit-select" onchange="updateLimits()">
                                <option>2</option>
                                <option>3</option>
                                <option selected>4</option>
                                <option>5</option>
                                <option>6</option>
                                <option>7</option>
                                <option>8</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="rit-label" data-title="Willpower" data-desc="Auto-success." data-ref="M20 Quickstart p.10">Willpower</label>
                            <select id="will" class="rit-select" onchange="updateLimits()">
                                <option>3</option>
                                <option>4</option>
                                <option selected>5</option>
                                <option>6</option>
                                <option>7</option>
                                <option>8</option>
                                <option>9</option>
                                <option>10</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label class="rit-label" data-title="Highest Sphere" data-desc="Base Difficulty." data-ref="M20 Quickstart p.18">Sphere</label>
                            <div class="counter">
                                <button class="btn-cnt" onclick="modifyState('sphere', -1)">-</button>
                                <div class="cnt-display" id="val-sphere">3</div>
                                <button class="btn-cnt" onclick="modifyState('sphere', 1)">+</button>
                            </div>
                        </div>
                        <div class="input-group">
                            <label class="rit-label" style="text-align:center;" data-title="Specialty" data-desc="10s count as 2 successes." data-ref="M20 Core Rule">Spec</label>
                            <div id="btn-spec" class="btn-square" onclick="toggleSpecialty()">
                                <div class="btn-square-inner"></div>
                            </div>
                        </div>
                    </div>

                    <div class="work-area">
                        <div class="work-panel">
                            <span class="section-title">CASTING CONTEXT</span>
                            <div class="grid-2">
                                <div class="input-group">
                                    <label class="rit-label">Reality</label>
                                    <select id="sel-reality" class="rit-select" onchange="recalculate()">
                                        <option value="3">Coincidental</option>
                                        <option value="4">Vulgar</option>
                                        <option value="5">Witness</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="rit-label">Speed</label>
                                    <select id="sel-speed" class="rit-select" onchange="recalculate()">
                                        <option value="0">Normal</option>
                                        <option value="-1">Slow (-1)</option>
                                        <option value="1">Fast (+1)</option>
                                    </select>
                                </div>
                            </div>

                            <label class="rit-label" style="margin-top:5px;">Bonuses</label>
                            <div class="grid-3-tool">
                                <div class="btn-tool" id="btn-sanctum" onclick="toggleState('sanctum')">🏰 Sanct</div>
                                <div class="btn-tool" id="btn-inst" onclick="toggleState('inst')">🔮 Focus</div>
                                <div class="btn-tool" id="btn-res" onclick="toggleState('res')">📚 Lib</div>
                                <div class="btn-tool" id="btn-quint" onclick="toggleState('quint')">
                                    ✨ Quint <span id="badge-quint" class="tool-badge" style="display:none;">0</span>
                                </div>
                                <div class="btn-tool" id="btn-team" onclick="toggleState('team')">🤝 Team</div>
                                <div class="btn-tool" id="btn-syn" onclick="toggleState('syn')">☯️ Syn</div>
                            </div>

                            <label class="rit-label" style="color:var(--danger)">Penalties (Max +3 Net)</label>
                            <div class="grid-2" style="margin-top:8px;">
                                <div class="input-group">
                                    <label class="rit-label">Bonus Dice</label>
                                    <div class="counter" style="border-color:var(--primary);">
                                        <button class="btn-cnt" onclick="modifyState('bonusDice', -1)">-</button>
                                        <div class="cnt-display" id="val-bonusDice" style="color:var(--primary);">0</div>
                                        <button class="btn-cnt" onclick="modifyState('bonusDice', 1)">+</button>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label class="rit-label">Auto Suc</label>
                                    <div class="counter" style="border-color:var(--success);">
                                        <button class="btn-cnt" onclick="modifyState('autoSuc', -1)">-</button>
                                        <div class="cnt-display" id="val-autoSuc" style="color:var(--success);">0</div>
                                        <button class="btn-cnt" onclick="modifyState('autoSuc', 1)">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="grid-2">
                                <div class="btn-tool neg" id="btn-notool" onclick="toggleState('notool')">🚫 No Tool</div>
                                <div class="btn-tool neg" id="btn-discord" onclick="toggleState('discord')">⚡ Discord</div>
                            </div>

                            <div class="input-group">
                                <label class="rit-label" style="color:var(--danger)">Distraction</label>
                                <div class="counter" style="border-color:rgba(239,68,68,0.3);">
                                    <button class="btn-cnt" onclick="modifyState('distract', -1)">-</button>
                                    <div class="cnt-display" id="val-distract" style="color:var(--danger)">0</div>
                                    <button class="btn-cnt" onclick="modifyState('distract', 1)">+</button>
                                </div>
                            </div>
                        </div>

                        <div class="work-panel">
                            <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:8px; margin-bottom:4px;">
                                <span class="section-title" style="border:none; margin:0; padding:0; color:var(--success);">SPELL PARAMETERS</span>
                                <div class="btn-tool" id="btn-hb" onclick="toggleState('hb')" style="padding:2px 8px; font-size:0.6rem; height:auto;">🏠 Homebrew</div>
                            </div>

                            <div class="grid-2">
                                <div class="input-group">
                                    <label class="rit-label">Duration</label>
                                    <select id="sel-dur" class="rit-select" onchange="recalculate()">
                                        <option value="0">One Turn</option>
                                        <option value="1">One Scene</option>
                                        <option value="2">One Day</option>
                                        <option value="3">One Story</option>
                                        <option value="4">Six Months</option>
                                        <option value="5">Permanent (10+)</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label class="rit-label">Target/Area</label>
                                    <select id="sel-targ" class="rit-select" onchange="recalculate()">
                                        <option value="0">Self / 1</option>
                                        <option value="1">2-4 / 5m</option>
                                        <option value="2">5-10 / 10m</option>
                                        <option value="3">Mass / Build</option>
                                    </select>
                                </div>
                            </div>

                            <div class="slider-wrapper">
                                <div class="slider-top">
                                    <select id="sel-dmg-type" onchange="recalculate()" class="mini-sel">
                                        <option value="Lethal" style="color:var(--warning)">LETHAL DMG</option>
                                        <option value="Bashing" style="color:var(--accent)">BASHING DMG</option>
                                        <option value="Aggravated" style="color:var(--danger)">AGGRAVATED</option>
                                    </select>
                                    <span class="slider-cost" id="cost-dmg">+0 Suc</span>
                                </div>
                                <div class="slider-val" id="txt-dmg" style="text-align:center; margin-bottom:5px;">0 Levels</div>
                                <input type="range" id="rng-dmg" min="0" max="20" value="0" oninput="recalculate()">
                            </div>

                            <div class="grid-2">
                                <div class="input-group">
                                    <label class="rit-label">Feat Magnitude</label>
                                    <div class="counter">
                                        <button class="btn-cnt" onclick="modifyState('extra', -1)">-</button>
                                        <div class="cnt-display" id="val-extra">0</div>
                                        <button class="btn-cnt" onclick="modifyState('extra', 1)">+</button>
                                    </div>
                                </div>
                                <div class="input-group">
                                    <label class="rit-label" style="color:var(--danger)">Opposition</label>
                                    <div class="counter" style="border-color:rgba(239,68,68,0.3);">
                                        <button class="btn-cnt" onclick="modifyState('resist', -1)">-</button>
                                        <div class="cnt-display" id="val-resist" style="color:var(--danger)">0</div>
                                        <button class="btn-cnt" onclick="modifyState('resist', 1)">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="panel control-panel" style="margin-top: 20px;">
                                <div class="panel-header" style="display:flex; justify-content:space-between; margin-bottom:10px;">
                                    <span class="ph-title" style="font-weight:800; color:#aaa;">RITUAL CONTROLS</span>
                                </div>

                                <div class="result-bar" style="margin-bottom:10px;">
                                    <div class="result-box">
                                        <span class="res-lbl">DIFFICULTY</span>
                                        <input type="number" id="disp-diff" class="res-val val-diff" value="6" min="3" max="9" onchange="manualOverride('diff')">
                                    </div>
                                    <div class="result-box">
                                        <span class="res-lbl">GOAL SUC</span>
                                        <input type="number" id="disp-goal" class="res-val val-goal" value="1" onchange="manualOverride('goal')">
                                    </div>
                                    <button id="btn-cast" class="btn-cast-compact style-inst" onclick="castSpell()">CAST SPELL</button>
                                </div>

                                <div style="text-align:center; font-size:0.6rem; color:var(--text-muted); margin-bottom:10px;">
                                    Roll Limit (Arete + Will): <strong id="val-limit" style="color:#fff">9</strong>
                                </div>

                                <div class="safety-wrapper">
                                    <button id="toggle-safety" class="btn-safety" onclick="toggleState('pauseOnDiff')">
                                        <svg viewBox="0 0 24 24" style="width:18px; height:18px; margin-right:8px; fill:currentColor;"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15h-2v-6h2v6zm0-8h-2V7h2v2z" /></svg>
                                        SAFETY: PAUSE ON DIFF INCREASE
                                    </button>

                                    <button id="toggle-manual" class="btn-safety" onclick="toggleState('manualRitual')">
                                        <svg viewBox="0 0 24 24" style="width:18px; height:18px; margin-right:8px; fill:currentColor;"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-9 14l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" /></svg>
                                        STEP-BY-STEP: ROLL 1 TURN
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="log-container" style="display:none;">
                        <div class="log-head">
                            <span id="log-title">System Log</span>
                            <span id="prog-txt"></span>
                        </div>
                        <div class="prog-bg"><div class="prog-fill" id="p-bar"></div></div>
                        <div id="logs" class="log-scroll"></div>
                    </div>

                </div>
            </div>

            <div id="sub-gens" class="sub-tab-content">
                <div class="gen-section">
                    <div class="tools-grid">
                        <div class="control-panel" style="grid-column: span 2;">
                            <label class="rit-label">QUICK DICE ROLLER</label>
                            <div style="display:flex; gap:12px; margin-top:10px; justify-content: center; align-items: flex-end;">
                                <div style="display:flex; flex-direction:column; gap:5px; align-items:center;">
                                    <span class="rit-label" style="font-size:0.65rem; color:var(--text-muted); letter-spacing:0.5px;">DICE POOL</span>
                                    <input type="number" id="q-pool" placeholder="#" value="6" class="gen-input" style="width:80px;">
                                </div>
                                <div style="display:flex; flex-direction:column; gap:5px; align-items:center;">
                                    <span class="rit-label" style="font-size:0.65rem; color:var(--text-muted); letter-spacing:0.5px;">DIFF</span>
                                    <input type="number" id="q-diff" placeholder="#" value="6" class="gen-input" style="width:80px;">
                                </div>
                                <button class="gen-btn" style="width: auto; margin:0; height:46px; background:var(--primary); color:#fff; padding: 0 24px; border:1px solid var(--primary);" onclick="quickRoll()">ROLL</button>
                            </div>
                            <div id="q-res" class="gen-res" style="font-size:1.4rem; margin-top:20px;">-</div>
                        </div>

                        <div class="control-panel">
                            <label class="rit-label">INSTANT NPC</label>
                            <button class="gen-btn" onclick="genNPC()">GENERATE</button>
                            <div id="res-npc" class="gen-res">...</div>
                        </div>

                        <div class="control-panel">
                            <label class="rit-label">RESONANCE</label>
                            <button class="gen-btn" onclick="genRes()">GENERATE</button>
                            <div id="res-rez" class="gen-res">...</div>
                        </div>

                        <div class="control-panel" style="grid-column: span 2;">
                            <label class="rit-label" style="color:var(--danger)">PARADOX FLAW</label>
                            <button class="gen-btn" style="border-color:var(--danger); color:var(--danger);" onclick="genFlaw()">SPARK CHAOS</button>
                            <div id="res-flaw" class="gen-res" style="color:#fff; font-weight:400;">...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <footer class="site-footer">
        <div class="footer-legal-container">
            <a href="https://www.worldofdarkness.com/dark-pack" target="_blank">
                <img src="DarkPack_Logo2.png" alt="Dark Pack Logo" class="darkpack-logo">
            </a>
            <div class="legal-text">
                <div class="unofficial-badge">Not official. Just Fan Made.</div>
                <p>Portions of the materials are the copyrights and trademarks of Paradox Interactive AB, and are used with permission. All rights reserved. For more information please visit <a href="https://www.worldofdarkness.com/" target="_blank">worldofdarkness.com</a>.</p>
                <p>This tool is an unofficial fan project and is not affiliated with, endorsed, sponsored, or specifically approved by Paradox Interactive.</p>
            </div>
        </div>

        <button class="btn-report" onclick="openFeedback()">
            <svg viewBox="0 0 24 24" width="14" height="14" fill="currentColor">
                <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z" />
            </svg>
            Report Bug / Contact
        </button>
    </footer>

    <div id="tooltip">
        <span class="tt-title"></span>
        <span class="tt-desc"></span>
        <span class="tt-ref"></span>
    </div>

    <div id="error-modal">
        <div class="modal-box">
            <div class="modal-title">⚠ Rule Violation</div>
            <div class="modal-text">Your Sphere rating cannot exceed your Arete rating.</div>
            <div class="tt-ref" style="margin-bottom:15px;">Reference: M20 Core Rulebook, p.251</div>
            <button class="modal-btn" onclick="closeError()">UNDERSTOOD</button>
        </div>
    </div>

    <div id="feedback-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="rit-title" style="font-size:1rem; margin:0;">TRANSMISSION</h3>
                <span class="close-btn" onclick="closeFeedback()">&times;</span>
            </div>
            <form id="contactForm" onsubmit="sendFeedback(event)">
                <input type="hidden" name="access_key" value="6cf12a40-9f8e-4b22-b3a6-47b2616e0a25">
                <input type="checkbox" name="botcheck" class="hidden" style="display: none;">

                <div class="input-group">
                    <label class="rit-label">Identity (Optional)</label>
                    <input type="text" name="name" class="rit-select" placeholder="Mage Name or Email">
                </div>

                <div class="input-group" style="margin-top:10px;">
                    <label class="rit-label">Signal Data</label>
                    <textarea name="message" class="rit-select" rows="4" placeholder="Describe the glitch or request..." required style="resize: vertical;"></textarea>
                </div>

                <button type="submit" class="btn-cast style-rit" id="form-submit-btn" style="margin-top:15px; font-size: 0.9rem; padding: 15px;">SEND SIGNAL</button>
                <div id="form-result" style="margin-top:10px; font-size:0.8rem; display:none;"></div>
            </form>
        </div>
    </div>

    <script src="data.js"></script>

    <script src="ritualmatic.js"></script>

    <script src="app.js?v=2.6"></script>

</body>
</html>