<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mage: The Ascension - Ultimate Node</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            /* GLOBAL THEME VARIABLES */
            --bg: #0e0e10;
            --surface: #18181b;
            --surface-light: #27272a;
            --primary: #a78bfa; 
            --primary-dim: rgba(167, 139, 250, 0.1);
            --accent: #22d3ee;
            --success: #34d399;
            --danger: #fb7185;
            --warning: #fbbf24;
            --text: #f4f4f5;
            --text-muted: #a1a1aa;
            --hb: #f59e0b;
            --pause: #f97316; 
            --border: rgba(255, 255, 255, 0.08);
            --radius: 12px;
            
            /* Typography */
            --fs-xs: 0.7rem;
            --fs-sm: 0.85rem;
            --fs-md: 1rem;
            --fs-lg: 1.25rem;
            --fs-xl: 3.2rem;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg); color: var(--text);
            font-family: 'Montserrat', sans-serif; margin: 0; padding: 0;
            height: 100vh; display: flex; overflow: hidden;
        }

        /* GRAIN BACKGROUND (Global) */
        body::before {
            content: ""; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: -1; opacity: 0.05;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.65' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
            background-size: 150px 150px; 
        }

        /* --- LAYOUT SPLIT --- */
        .split-container {
            display: flex; width: 100%; height: 100%;
        }
        .left-panel, .right-panel {
            flex: 1; overflow-y: auto; padding: 20px;
            display: flex; flex-direction: column; gap: 20px;
        }
        .left-panel { border-right: 1px solid var(--border); background: rgba(0,0,0,0.2); }
        .right-panel { background: transparent; }

        /* SCROLLBARS */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--bg); }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; border: 2px solid var(--bg); }

        /* --- SHARED STYLES --- */
        h1 { 
            margin: 0; font-size: 1.5rem; font-weight: 900; letter-spacing: -0.5px; 
            background: linear-gradient(to right, #fff, #a78bfa); 
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            text-transform: uppercase;
        }
        
        .panel {
            background: var(--surface); border-radius: var(--radius); 
            border: 1px solid var(--border); display: flex; flex-direction: column;
            backdrop-filter: blur(10px);
        }
        .panel-head {
            padding: 15px 20px; border-bottom: 1px solid var(--border);
            font-size: 0.85rem; font-weight: 800; color: var(--accent); 
            text-transform: uppercase; letter-spacing: 1px; background: rgba(0,0,0,0.2);
            cursor: pointer; display: flex; justify-content: space-between; align-items: center; user-select: none;
        }
        .panel-head:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .panel-body { padding: 0; display: block; }
        .panel-body.closed { display: none; }

        /* --- LEFT SIDE SPECIFIC (GM SCREEN) --- */
        .search-wrapper { position: relative; width: 100%; margin-bottom: 10px; }
        .search-icon { position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.9rem; pointer-events: none; }
        .search-input {
            width: 100%; padding: 12px 40px; border-radius: 30px; background: var(--surface-light); 
            border: 1px solid var(--border); color: #fff; font-family: inherit; font-weight: 600; font-size: 0.9rem; outline: none;
        }
        .search-input:focus { border-color: var(--primary); background: rgba(40,40,50,0.8); }
        .search-clear { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); background: transparent; border: none; color: var(--text-muted); cursor: pointer; display: none; }
        .search-input:not(:placeholder-shown) + .search-clear { display: block; }

        /* Accordions & Lists (GM Screen) */
        .acc-item { border-bottom: 1px solid var(--border); }
        .acc-head { padding: 12px 20px; font-size: 0.8rem; font-weight: 700; cursor: pointer; display: flex; justify-content: space-between; color: var(--text); }
        .acc-head:hover { color: var(--primary); background: rgba(255,255,255,0.03); }
        .acc-body { display: none; padding: 15px 20px; background: rgba(0,0,0,0.2); font-size: 0.8rem; line-height: 1.5; color: var(--text-muted); border-top: 1px solid rgba(255,255,255,0.05); }
        .acc-item.open .acc-body { display: block; }
        .acc-item.open .acc-head { color: var(--accent); }

        .sphere-list { list-style: none; padding: 0; margin: 0; }
        .sphere-list li { padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.05); display: flex; align-items: baseline; }
        .rank-num { color: var(--primary); font-weight: 800; margin-right: 8px; }

        .combo-cat { color: var(--warning); font-weight: 800; font-size: 0.7rem; text-transform: uppercase; margin-top: 10px; padding-bottom: 4px; border-bottom: 1px solid var(--border); }
        .combo-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px dashed rgba(255,255,255,0.05); cursor: help; }
        .combo-item:hover { color: var(--accent); }
        .combo-req { font-family: monospace; font-size: 0.7rem; color: var(--text-muted); }

        table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
        th { text-align: left; border-bottom: 1px solid var(--border); padding: 4px; color: var(--text); opacity: 0.7; }
        td { padding: 4px; border-bottom: 1px solid rgba(255,255,255,0.03); }
        .col-hl { color: var(--primary); font-weight: 700; }

        .gen-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
        .gen-card { background: var(--surface-light); border: 1px solid var(--border); border-radius: 8px; padding: 10px; text-align: center; }
        .gen-label { font-size: 0.6rem; font-weight: 800; color: var(--text-muted); display: block; margin-bottom: 4px; }
        .gen-val { font-size: 0.8rem; font-weight: 700; color: var(--accent); min-height: 18px; }
        .btn-gen { background: rgba(255,255,255,0.05); border: 1px solid var(--border); color: #fff; width: 100%; padding: 6px; font-size: 0.65rem; font-weight: 700; cursor: pointer; margin-top: 5px; border-radius: 4px; }
        .btn-gen:hover { border-color: var(--accent); }

        /* --- RIGHT SIDE SPECIFIC (RITUALMATIC) --- */
        .rit-header { display: flex; justify-content: space-between; align-items: center; }
        .btn-reset { background: transparent; border: 1px solid var(--danger); color: var(--danger); padding: 8px 14px; border-radius: 8px; font-size: 0.65rem; font-weight: 800; cursor: pointer; }
        .btn-reset:active { background: var(--danger); color: #fff; }

        .mode-switch { display: flex; background: var(--surface-light); padding: 4px; border-radius: 12px; }
        .seg-btn { flex: 1; text-align: center; padding: 10px; font-size: var(--fs-sm); font-weight: 700; border-radius: 8px; cursor: pointer; color: var(--text-muted); transition: 0.2s; }
        .seg-btn.active { background: var(--primary); color: #fff; }

        .hud-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .hud-card { background: var(--surface); border-radius: 16px; padding: 15px; text-align: center; border: 1px solid var(--border); }
        .hud-label { font-size: var(--fs-xs); color: var(--text-muted); font-weight: 700; display: block; margin-bottom: 5px; }
        .hud-input { background: transparent; border: none; text-align: center; width: 100%; font-family: inherit; font-size: 2.5rem; font-weight: 900; color: var(--text); outline: none; }
        .val-diff { color: #c4b5fd; } .val-goal { color: #6ee7b7; } .modified { color: var(--warning); }

        .input-group { margin-bottom: 12px; }
        label { font-size: var(--fs-xs); font-weight: 700; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 6px; }
        select { width: 100%; background: var(--surface-light); color: #fff; border: 1px solid transparent; padding: 12px; border-radius: 10px; font-family: inherit; font-weight: 600; outline: none; }
        select:focus { border-color: var(--primary); }

        .counter { display: flex; background: var(--surface-light); border-radius: 10px; overflow: hidden; height: 44px; }
        .btn-cnt { width: 44px; border: none; background: rgba(255,255,255,0.05); color: #fff; font-size: 1.2rem; cursor: pointer; }
        .cnt-display { flex: 1; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 1.1rem; }

        .tools-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
        .btn-tool { background: var(--surface-light); padding: 12px; border-radius: 8px; text-align: center; font-size: 0.7rem; font-weight: 700; color: var(--text-muted); cursor: pointer; border: 1px solid transparent; }
        .btn-tool.active { background: var(--primary-dim); border-color: var(--primary); color: var(--primary); }
        .btn-tool.neg.active { border-color: var(--danger); color: var(--danger); background: rgba(239, 68, 68, 0.15); }

        .btn-cast { width: 100%; padding: 20px; border: none; border-radius: 12px; font-family: inherit; font-size: 1.1rem; font-weight: 900; color: #fff; cursor: pointer; margin-top: 10px; }
        .style-inst { background: linear-gradient(135deg, #f97316, #ea580c); }
        .style-rit { background: linear-gradient(135deg, #8b5cf6, #6d28d9); }
        .style-pause { background: var(--hb); color:#000; animation: pulse 2s infinite; }

        #log-container { display: none; background: var(--surface); padding: 15px; border-radius: 12px; margin-top: 15px; border: 1px solid var(--border); }
        .log-scroll { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; }
        .entry { background: var(--surface-light); padding: 10px; border-radius: 8px; border-left: 4px solid #444; font-size: 0.85rem; display: flex; justify-content: space-between; }
        .entry.success { border-color: var(--success); } .entry.fail { border-color: var(--warning); } .entry.botch { border-color: var(--danger); }
        
        /* TOOLTIP */
        #tooltip { position: fixed; display: none; pointer-events: none; z-index: 9999; background: rgba(24, 24, 27, 0.98); border: 1px solid var(--primary); border-radius: 8px; padding: 12px; max-width: 280px; box-shadow: 0 10px 40px rgba(0,0,0,0.9); }
        .tt-title { color: var(--accent); font-size: 0.7rem; font-weight: 800; display: block; margin-bottom: 4px; }
        .tt-desc { color: #eee; font-size: 0.75rem; }
        .tt-ref { color: var(--text-muted); font-size: 0.65rem; font-style: italic; margin-top: 8px; display: block; border-top: 1px solid #444; padding-top: 4px;}

        /* MOBILE FIX */
        @media (max-width: 900px) { .split-container { flex-direction: column; } .left-panel { border-right: none; border-bottom: 1px solid var(--border); height: 50%; } }
    </style>
</head>
<body>

<div id="tooltip"><span class="tt-title"></span><span class="tt-desc"></span><span class="tt-ref"></span></div>

<div class="split-container">
    
    <div class="left-panel">
        <header style="display:flex; justify-content:space-between; align-items:center;">
            <h1>GM Screen</h1>
            <div style="font-size:0.7rem; color:var(--text-muted);">M20 Database</div>
        </header>

        <div class="search-wrapper">
            <span class="search-icon">üîç</span>
            <input type="text" id="searchBox" class="search-input" placeholder="Search Spheres, Rotes, Rules..." onkeyup="filterContent()">
            <button class="search-clear" onclick="clearSearch()">‚úï</button>
        </div>

        <div class="panel">
            <div class="panel-head" onclick="togglePanel(this)">Spheres <span>-</span></div>
            <div class="panel-body">
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">üåê Correspondence</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Perception</li><li><span class="rank-num">2</span> Sense/Touch</li><li><span class="rank-num">3</span> Pierce Space</li><li><span class="rank-num">4</span> Rend Space</li><li><span class="rank-num">5</span> Mutate Space</li></ul></div></div>
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">‚ú® Prime</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Sense Prime</li><li><span class="rank-num">2</span> Fuel Pattern</li><li><span class="rank-num">3</span> Channel</li><li><span class="rank-num">4</span> Expel Energy</li><li><span class="rank-num">5</span> Mastery</li></ul></div></div>
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">‚è≥ Time</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Time Sense</li><li><span class="rank-num">2</span> Post/Precognition</li><li><span class="rank-num">3</span> Time Control</li><li><span class="rank-num">4</span> Time Bubble</li><li><span class="rank-num">5</span> Time Travel</li></ul></div></div>
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">üî• Forces</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Perceive</li><li><span class="rank-num">2</span> Control Minor</li><li><span class="rank-num">3</span> Transmute Minor</li><li><span class="rank-num">4</span> Control Major</li><li><span class="rank-num">5</span> Transmute Major</li></ul></div></div>
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">üß¨ Life</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Sense Life</li><li><span class="rank-num">2</span> Alter Simple</li><li><span class="rank-num">3</span> Alter Self/Complex</li><li><span class="rank-num">4</span> Alter Complex</li><li><span class="rank-num">5</span> Create Life</li></ul></div></div>
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">üß± Matter</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Analysis</li><li><span class="rank-num">2</span> Transmute Basic</li><li><span class="rank-num">3</span> Alter Form</li><li><span class="rank-num">4</span> Complex</li><li><span class="rank-num">5</span> Create Matter</li></ul></div></div>
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">üß† Mind</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Sense Thought</li><li><span class="rank-num">2</span> Read Surface</li><li><span class="rank-num">3</span> Mental Link</li><li><span class="rank-num">4</span> Control Mind</li><li><span class="rank-num">5</span> Create Mind</li></ul></div></div>
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">üëª Spirit</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Spirit Sight</li><li><span class="rank-num">2</span> Touch Spirit</li><li><span class="rank-num">3</span> Step Sideways</li><li><span class="rank-num">4</span> Bind Spirit</li><li><span class="rank-num">5</span> Forge Spirit</li></ul></div></div>
                <div class="acc-item"><div class="acc-head" onclick="toggleAcc(this)">üé≤ Entropy</div><div class="acc-body"><ul class="sphere-list"><li><span class="rank-num">1</span> Sense Fate</li><li><span class="rank-num">2</span> Probability</li><li><span class="rank-num">3</span> Affect Matter</li><li><span class="rank-num">4</span> Affect Life</li><li><span class="rank-num">5</span> Affect Thought</li></ul></div></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-head" onclick="togglePanel(this)" style="color:var(--warning)">Common Rotes <span>-</span></div>
            <div class="panel-body" style="padding:10px;">
                <div class="combo-cat">Combat</div>
                <div class="combo-item" data-title="Aggravated Wound" data-desc="Burns internal organs." data-ref="HDYDT p.33"><span>Internal Burn (Agg)</span> <span class="combo-req">Life 3 + Forces 2</span></div>
                <div class="combo-item" data-title="Sunlight" data-desc="True sunlight vs Vampires." data-ref="HDYDT p.32"><span>Artificial Sunlight</span> <span class="combo-req">Forces 3 + Prime 2</span></div>
                <div class="combo-item" data-title="Chain Lightning" data-desc="Arcing electrical blast." data-ref="HDYDT p.37"><span>Chain Lightning</span> <span class="combo-req">Forces 3 + Prime 2</span></div>
                <div class="combo-item" data-title="Kinetic Punch" data-desc="Increase velocity." data-ref="HDYDT p.30"><span>Kinetic Strike</span> <span class="combo-req">Forces 2</span></div>
                <div class="combo-cat">Defense</div>
                <div class="combo-item" data-title="Iron Skin" data-desc="Soak Aggravated damage." data-ref="HDYDT p.67"><span>Iron Skin</span> <span class="combo-req">Life 3 + Matter 3</span></div>
                <div class="combo-item" data-title="Counter-Magic" data-desc="General anti-magic field." data-ref="M20 p.545"><span>Null Zone</span> <span class="combo-req">Prime 2</span></div>
                <div class="combo-item" data-title="Invisibility" data-desc="Bends light around self." data-ref="HDYDT p.34"><span>Invisibility</span> <span class="combo-req">Forces 2</span></div>
                <div class="combo-cat">Utility</div>
                <div class="combo-item" data-title="Teleport" data-desc="Instant travel self." data-ref="M20 p.512"><span>Teleport Self</span> <span class="combo-req">Corr 3</span></div>
                <div class="combo-item" data-title="Step Sideways" data-desc="Enter Penumbra." data-ref="HDYDT p.524"><span>Umbral Step</span> <span class="combo-req">Spirit 3</span></div>
                <div class="combo-item" data-title="Mind Read" data-desc="Deep probe." data-ref="HDYDT p.115"><span>Mind Read</span> <span class="combo-req">Mind 3</span></div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-head" onclick="togglePanel(this)">Rules & Tables <span>-</span></div>
            <div class="panel-body">
                 <div class="acc-item">
                    <div class="acc-head" onclick="toggleAcc(this)">Paradox Backlash <span>+</span></div>
                    <div class="acc-body">
                        <table>
                            <tr><th>Suc</th><th>Effect</th></tr>
                            <tr><td>1-5</td><td>1 pt/suc. Bashing or Trivial.</td></tr>
                            <tr><td>6-10</td><td>1 pt/suc. Burn (Bash) or Minor.</td></tr>
                            <tr><td>11-15</td><td>Lethal Burn + Sig Flaw.</td></tr>
                            <tr><td>16+</td><td>Agg Burn + Perm Paradox.</td></tr>
                        </table>
                    </div>
                </div>
                <div class="acc-item">
                     <div class="acc-head" onclick="toggleAcc(this)">Damage & Healing <span>+</span></div>
                     <div class="acc-body">
                        <table>
                            <tr><th>Type</th><th>Recovery</th><th>Heal</th></tr>
                            <tr><td style="color:var(--primary)">Bashing</td><td>1 / Hour</td><td>Life 2</td></tr>
                            <tr><td style="color:var(--warning)">Lethal</td><td>1 / Day(s)</td><td>Life 3</td></tr>
                            <tr><td style="color:var(--danger)">Aggravated</td><td>1 / Week</td><td>L3 + Quint</td></tr>
                        </table>
                     </div>
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-head" onclick="togglePanel(this)">Generators <span>-</span></div>
            <div class="panel-body" style="padding:15px;">
                <div class="gen-grid">
                    <div class="gen-card">
                        <span class="gen-label">INSTANT NPC</span>
                        <div class="gen-val" id="res-npc">...</div>
                        <button class="btn-gen" onclick="genNPC()">GENERATE</button>
                    </div>
                    <div class="gen-card">
                        <span class="gen-label">RESONANCE</span>
                        <div class="gen-val" id="res-rez">...</div>
                        <button class="btn-gen" onclick="genRes()">GENERATE</button>
                    </div>
                    <div class="gen-card">
                        <span class="gen-label">PARADOX FLAW</span>
                        <div class="gen-val" id="res-flaw" style="font-weight:400; color:#fff; font-size:0.7rem;">...</div>
                        <button class="btn-gen" onclick="genFlaw()">SPARK CHAOS</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="right-panel">
        <header class="rit-header">
            <h1>Ritualmatic</h1>
            <button class="btn-reset" onclick="resetAll()">RESET ALL</button>
        </header>

        <div class="mode-switch">
            <div class="seg-btn active" id="btn-m-inst" onclick="mode('instant')">Instant</div>
            <div class="seg-btn" id="btn-m-rit" onclick="mode('ritual')">Ritual</div>
        </div>

        <div class="hud-grid">
            <div class="hud-card">
                <span class="hud-label">Difficulty</span>
                <input type="number" id="disp-diff" class="hud-input val-diff" value="6" onchange="manualOverride('diff')">
            </div>
            <div class="hud-card">
                <span class="hud-label">Goal Successes</span>
                <input type="number" id="disp-goal" class="hud-input val-goal" value="1" onchange="manualOverride('goal')">
            </div>
        </div>

        <div class="panel" style="padding:15px;">
            <div class="input-group">
                <label>Highest Sphere</label>
                <div class="counter">
                    <button class="btn-cnt" onclick="mod('sphere', -1)">-</button>
                    <div class="cnt-display" id="val-sphere">3</div>
                    <button class="btn-cnt" onclick="mod('sphere', 1)">+</button>
                </div>
            </div>

             <div class="input-group">
                <label>Reality / Speed</label>
                <div style="display:flex; gap:10px;">
                    <select id="sel-reality" onchange="calc()">
                        <option value="3">Coincidental (+3)</option>
                        <option value="4">Vulgar (+4)</option>
                        <option value="5">Witness (+5)</option>
                    </select>
                     <select id="sel-speed" onchange="calc()">
                        <option value="0">Normal</option>
                        <option value="-1">Slow (-1)</option>
                        <option value="1">Fast (+1)</option>
                    </select>
                </div>
            </div>

            <div class="input-group">
                <label>Bonuses</label>
                <div class="tools-grid">
                    <div class="btn-tool" id="btn-sanctum" onclick="tog('sanctum')">üè∞ Sanct</div>
                    <div class="btn-tool" id="btn-inst" onclick="tog('inst')">üîÆ Focus</div>
                    <div class="btn-tool" id="btn-quint" onclick="tog('quint')">‚ú® Quint</div>
                </div>
            </div>

            <div class="input-group">
                 <label>Arete</label>
                 <div class="counter">
                    <button class="btn-cnt" onclick="mod('arete', -1)">-</button>
                    <div class="cnt-display" id="val-arete">4</div>
                    <button class="btn-cnt" onclick="mod('arete', 1)">+</button>
                </div>
            </div>
        </div>

        <button id="btn-cast" class="btn-cast style-inst" onclick="cast()">CAST SPELL</button>

        <div id="log-container">
            <div class="log-scroll" id="logs"></div>
        </div>
    </div>

</div>

<script>
    /* --- SHARED JS UTILS --- */
    function roll(sides=10) { return Math.floor(Math.random()*sides)+1; }

    /* --- LEFT PANEL LOGIC (GM SCREEN) --- */
    // Search
    function filterContent() {
        let input = document.getElementById('searchBox').value.toUpperCase();
        let items = document.querySelectorAll('.sphere-list li, .combo-item, .acc-item, .gen-card');
        
        if(input.length === 0) {
            items.forEach(el => el.style.display = "");
            return;
        }
        
        items.forEach(li => {
            let text = li.innerText;
            if(li.getAttribute('data-title')) text += " " + li.getAttribute('data-title');
            if(text.toUpperCase().indexOf(input) > -1) {
                li.style.display = "";
                // If inside accordion, open it
                let parent = li.closest('.acc-item');
                if(parent) { parent.classList.add('open'); }
            } else {
                li.style.display = "none";
            }
        });
    }
    function clearSearch() { document.getElementById('searchBox').value = ''; filterContent(); }

    // UI Toggles
    function toggleAcc(head) { head.parentElement.classList.toggle('open'); }
    function togglePanel(head) { 
        head.nextElementSibling.classList.toggle('closed'); 
        head.querySelector('span').innerText = head.nextElementSibling.classList.contains('closed') ? '+' : '-';
    }

    // Generators
    const npcRoles = ["Techno-Hacker", "Hermit", "Corporate Mage", "Street Shaman", "Cultist", "Hitman"];
    const npcTraits = ["Paranoid", "Arrogant", "Helpful", "Cryptic", "Aggressive", "Sleepy"];
    function genNPC() { document.getElementById('res-npc').innerText = `${npcTraits[Math.floor(Math.random()*npcTraits.length)]} ${npcRoles[Math.floor(Math.random()*npcRoles.length)]}`; }
    
    const resonances = ["Fiery (Dynamic)", "Cold (Stasis)", "Rotting (Entropic)", "Holy (Sacred)", "Industrial (Tech)"];
    function genRes() { document.getElementById('res-rez').innerText = resonances[Math.floor(Math.random()*resonances.length)]; }
    
    const flaws = ["Clocks run backwards.", "Shadows detach.", "Items levitate.", "Echoing voice.", "Tech glitch.", "Sulfur smell."];
    function genFlaw() { document.getElementById('res-flaw').innerText = flaws[Math.floor(Math.random()*flaws.length)]; }

    // Tooltip Logic (Global)
    const tt = document.getElementById('tooltip');
    const ttT=tt.querySelector('.tt-title'), ttD=tt.querySelector('.tt-desc'), ttR=tt.querySelector('.tt-ref');
    document.querySelectorAll('[data-title]').forEach(el => {
        el.addEventListener('mousemove', e => {
            tt.style.display = 'block';
            let x = e.clientX + 15, y = e.clientY + 15;
            if(x+280 > window.innerWidth) x = e.clientX - 295;
            tt.style.left = x+'px'; tt.style.top = y+'px';
            ttT.innerText = el.dataset.title; ttD.innerText = el.dataset.desc || ''; ttR.innerText = el.dataset.ref || '';
        });
        el.addEventListener('mouseleave', () => tt.style.display = 'none');
    });


    /* --- RIGHT PANEL LOGIC (RITUALMATIC) --- */
    let s = { mode:'instant', sphere:3, arete:4, gmDiff:0, gmGoal:0, sanctum:false, inst:false, quint:false };
    let activeTimer = null;
    let ritState = { totalSuc: 0, turn: 0, currentDiff: 6, isPaused: false, hasStarted: false };

    function resetAll() {
        s = { mode:'instant', sphere:3, arete:4, gmDiff:0, gmGoal:0, sanctum:false, inst:false, quint:false };
        ritState = { totalSuc: 0, turn: 0, currentDiff: 6, isPaused: false, hasStarted: false };
        if(activeTimer) clearInterval(activeTimer);
        document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('active'));
        document.getElementById('log-container').style.display='none';
        mode('instant'); updateUI(); calc();
    }

    function mode(m) {
        s.mode = m;
        document.getElementById('btn-m-inst').className = m==='instant' ? 'seg-btn active' : 'seg-btn';
        document.getElementById('btn-m-rit').className = m==='ritual' ? 'seg-btn active' : 'seg-btn';
        let btn = document.getElementById('btn-cast');
        btn.className = m==='instant' ? 'btn-cast style-inst' : 'btn-cast style-rit';
        btn.innerText = m==='instant' ? 'CAST INSTANT SPELL' : 'BEGIN RITUAL';
    }

    function mod(k, v) {
        if(k==='sphere') s.sphere = Math.max(1, Math.min(9, s.sphere + v));
        if(k==='arete') s.arete = Math.max(1, Math.min(10, s.arete + v));
        updateUI(); calc();
    }
    
    function updateUI() {
        document.getElementById('val-sphere').innerText = s.sphere;
        document.getElementById('val-arete').innerText = s.arete;
    }

    function tog(k) {
        s[k] = !s[k];
        document.getElementById('btn-'+k).classList.toggle('active');
        calc();
    }

    function calc() {
        let sph = s.sphere;
        let real = parseInt(document.getElementById('sel-reality').value);
        let spd = parseInt(document.getElementById('sel-speed').value);
        let bon = (s.sanctum?1:0) + (s.inst?1:0) + (s.quint?1:0);
        
        let diff = sph + real + spd - bon;
        if(diff < 3) diff = 3; if(diff > 10) diff = 10;
        
        let goal = 1; // Simplified for this view

        document.getElementById('disp-diff').value = diff + s.gmDiff;
        document.getElementById('disp-goal').value = goal + s.gmGoal;
    }
    
    function manualOverride(t) {
        let val = parseInt(document.getElementById('disp-'+t).value);
        if(t==='diff') s.gmDiff = val - (parseInt(document.getElementById('disp-diff').defaultValue)||6);
        // Simplified override logic
    }

    function cast() {
        // Simple Cast Logic for Combined View
        let diff = parseInt(document.getElementById('disp-diff').value);
        let arete = s.arete;
        let logs = document.getElementById('logs');
        document.getElementById('log-container').style.display = 'block';

        let suc=0, ones=0, res=[];
        for(let i=0; i<arete; i++) {
            let d = roll();
            if(d>=diff) suc++; if(d===1) ones++;
            res.push(d);
        }
        let net = suc - ones;
        let msg = net < 0 ? "BOTCH!" : (net === 0 ? "FAIL" : net + " SUCCESSES");
        let cls = net < 0 ? "botch" : (net === 0 ? "fail" : "success");
        
        logs.innerHTML = `<div class="entry ${cls}"><div><b>Diff ${diff}</b> [${res.join(',')}]</div><b>${msg}</b></div>` + logs.innerHTML;
    }

    calc(); updateUI();
</script>
</body>
</html>
